# ============================================================
#  General
# ============================================================
set  -g  mouse on
set  -g  history-limit 10000
set  -g  base-index 1
setw -g  pane-base-index 1
set  -g  default-terminal "screen-256color"
set  -g  terminal-overrides 'xterm:colors=256'
set  -s  set-clipboard on
set  -g  repeat-time 1500

# Prefix: Ctrl+Space
unbind-key C-b
set -g prefix C-Space
bind-key C-Space send-prefix

# ============================================================
#  Key Bindings – Copy Mode (vi style)
# ============================================================
setw -g mode-keys vi

# Scroll speed in copy-mode
bind-key -T copy-mode-vi WheelUpPane   send-keys -X -N 3 scroll-up
bind-key -T copy-mode-vi WheelDownPane send-keys -X -N 3 scroll-down

# Escape exits copy-mode
bind-key -T copy-mode-vi Escape send-keys -X cancel

# vim-style selection and yank
bind-key -T copy-mode-vi v   send-keys -X begin-selection
bind-key -T copy-mode-vi V   send-keys -X select-line
bind-key -T copy-mode-vi C-v send-keys -X rectangle-toggle
bind-key -T copy-mode-vi y   send-keys -X copy-selection-and-cancel

# Auto-enter copy-mode on wheel scroll
bind-key -n WheelUpPane   if-shell -F -t = "#{pane_in_mode}" \
  "send-keys -X -N 5 scroll-up" "copy-mode -e; send-keys -X -N 5 scroll-up"
bind-key -n WheelDownPane if-shell -F -t = "#{pane_in_mode}" \
  "send-keys -X -N 5 scroll-down" "send-keys -X -N 5 scroll-down"

# ============================================================
#  Key Bindings – Pane Splitting
# ============================================================
bind-key \\ split-window -h -c '#{pane_current_path}'
bind-key ¥  split-window -h -c '#{pane_current_path}'
bind-key |  split-window -h -c '#{pane_current_path}'
bind-key -  split-window -v -c '#{pane_current_path}'

# Pane navigation (vim-style hjkl)
bind-key h select-pane -L
bind-key j select-pane -D
bind-key k select-pane -U
bind-key l select-pane -R

# Pane navigation without prefix (Alt + hjkl)
bind-key -n M-h select-pane -L
bind-key -n M-j select-pane -D
bind-key -n M-k select-pane -U
bind-key -n M-l select-pane -R

# Pane resize (repeatable)
bind-key -r H resize-pane -L 5
bind-key -r J resize-pane -D 5
bind-key -r K resize-pane -U 5
bind-key -r L resize-pane -R 5

# Synchronize panes toggle
bind-key S setw synchronize-panes \; display-message "synchronize-panes: #{?synchronize-panes,ON,OFF}"

# ============================================================
#  Key Bindings – Window
# ============================================================
bind-key c   new-window -c '#{pane_current_path}'
bind-key Tab last-window
bind-key -r < swap-window -t -1 \; select-window -t -1
bind-key -r > swap-window -t +1 \; select-window -t +1

# Window jump without prefix (Alt + number)
bind-key -n M-1 select-window -t 1
bind-key -n M-2 select-window -t 2
bind-key -n M-3 select-window -t 3
bind-key -n M-4 select-window -t 4
bind-key -n M-5 select-window -t 5
bind-key -n M-6 select-window -t 6
bind-key -n M-7 select-window -t 7
bind-key -n M-8 select-window -t 8
bind-key -n M-9 select-window -t 9

# Previous/next window without prefix
bind-key -n 'M-[' previous-window
bind-key -n 'M-]' next-window

# ============================================================
#  Utility
# ============================================================
bind-key r source-file ~/.config/tmux/tmux.conf \; display-message "Config reloaded!"
bind-key g display-popup -w 80% -h 80% -E
bind-key G display-popup -w 90% -h 90% -E 'lazygit || git log --oneline --graph --all'

# ============================================================
#  Status Bar
# ============================================================
set  -g  status on
set  -g  status-justify left
set  -g  status-interval 1
set  -g  status-style "#{?client_prefix,bg=#af87ff fg=#1c1c1c,bg=#080808 fg=#a8a8a8}"
set  -g  status-left-length 60
set  -g  status-right-length 50

# -- Left: session name & host --------------------------------
set -g status-left "\
#{?client_prefix,\
#[fg=#1c1c1c]#[bg=#af87ff] #S #{?#{e|<:#{client_width},100},,#[fg=#7a5faf]│ #[fg=#1c1c1c]#{host} }#[fg=#7a5faf]│,\
#[fg=#af87ff] #S #{?#{e|<:#{client_width},100},,#[fg=#585858]│ #[fg=#a8a8a8]#{host} }#[fg=#585858]│}"

# -- Centre: window list --------------------------------------
setw -g window-status-format         "#{?client_prefix,#{?pane_synchronized,#[fg=#4e3a6e] #I:#W⇄ ,#[fg=#4e3a6e] #I:#W },#{?pane_synchronized,#[fg=#767676] #I:#W⇄ ,#[fg=#767676] #I:#W }}"
setw -g window-status-current-format "#{?client_prefix,#{?pane_synchronized,#[fg=#87d787]#[bg=#1c1c1c] #I:#W⇄ ,#[fg=#af87ff]#[bg=#1c1c1c] #I:#W },#{?pane_synchronized,#[fg=#080808]#[bg=#87d787] #I:#W⇄ ,#[fg=#080808]#[bg=#af87ff] #I:#W }}#[default]"
setw -g window-status-bell-style     "fg=#1c1c1c,bg=#d75f5f,bold"
setw -g window-status-separator      "#[fg=#585858]│"

# -- Right: system stats & clock -------------------------------
set -g status-right "\
#{?client_prefix,#[fg=#7a5faf],#[fg=#585858]}│ \
#{?#{e|<:#{client_width},100},,\
#{?client_prefix,#[fg=#4e3a6e],#[fg=#585858]}C:#{?client_prefix,#{?#{e|>=:#{@cpu_pct},80},#[fg=#d75f5f],#[fg=#1c1c1c]},#{?#{e|>=:#{@cpu_pct},80},#[fg=#d75f5f],#{?#{e|>=:#{@cpu_pct},50},#[fg=#d7af5f],#[fg=#87d787]}}}#(~/.config/tmux/cpu.sh)%% #{?client_prefix,#[fg=#7a5faf],#[fg=#585858]}│ \
#{?client_prefix,#[fg=#4e3a6e],#[fg=#585858]}M:#{?client_prefix,#{?#{e|>=:#{@mem_pct},80},#[fg=#d75f5f],#[fg=#1c1c1c]},#{?#{e|>=:#{@mem_pct},80},#[fg=#d75f5f],#{?#{e|>=:#{@mem_pct},50},#[fg=#d7af5f],#[fg=#87d787]}}}#(~/.config/tmux/mem.sh)%% #{?client_prefix,#[fg=#7a5faf],#[fg=#585858]}│ \
#{?client_prefix,#[fg=#4e3a6e],#[fg=#585858]}D:#{?client_prefix,#{?#{e|>=:#{@disk_pct},80},#[fg=#d75f5f],#[fg=#1c1c1c]},#{?#{e|>=:#{@disk_pct},80},#[fg=#d75f5f],#{?#{e|>=:#{@disk_pct},50},#[fg=#d7af5f],#[fg=#87d787]}}}#(~/.config/tmux/disk.sh)%% #{?client_prefix,#[fg=#7a5faf],#[fg=#585858]}│ \
#{?client_prefix,#[fg=#4e3a6e],#[fg=#767676]}%m/%d }#{?client_prefix,#[fg=#1c1c1c],#[fg=#a8a8a8]}%H:%M #[default]"

# ============================================================
#  Pane Border
# ============================================================
set -g pane-border-status       bottom
set -g pane-border-style        "fg=#303030"
set -g pane-active-border-style "fg=#af87ff"

set -g pane-border-format "\
#{?window_zoomed_flag,\
#{?pane_in_mode,\
#[bg=#d7af5f]#[fg=#7a6830] #P  ZOOM #[fg=#181818]#[bold] COPY #[nobold]\
 #[fg=#8b7535]│ #[fg=#181818]\
#(~/.config/tmux/short-path.sh #{pane_current_path}) \
#{?#{!=:#(cd #{pane_current_path} && git rev-parse --abbrev-ref HEAD 2>/dev/null),},\
#[fg=#8b7535]│ #[fg=#181818]#(cd #{pane_current_path} && git rev-parse --abbrev-ref HEAD 2>/dev/null) ,}\
#[fg=#8b7535]│ \
#{?#{m:*sh,#{pane_current_command}},,#[fg=#181818]▶ }\
#[fg=#181818]#{pane_current_command} ,\
#[bg=#87afd7]#[fg=#181818] #P #[bold] ZOOM #[nobold]\
 #[fg=#5a7a9a]│ #[fg=#181818]\
#(~/.config/tmux/short-path.sh #{pane_current_path}) \
#{?#{!=:#(cd #{pane_current_path} && git rev-parse --abbrev-ref HEAD 2>/dev/null),},\
#[fg=#5a7a9a]│ #[fg=#181818]#(cd #{pane_current_path} && git rev-parse --abbrev-ref HEAD 2>/dev/null) ,}\
#[fg=#5a7a9a]│ \
#{?#{m:*sh,#{pane_current_command}},,#[fg=#181818]▶ }\
#[fg=#181818]#{pane_current_command} },\
#{?pane_in_mode,\
#{?pane_active,#[bg=#d7af5f]#[fg=#181818],#[bg=default]#[fg=#968a6a]} #P #[bold] COPY #[nobold]\
 #{?pane_active,#[fg=#8b7535],#[fg=#585858]}│ #{?pane_active,#[fg=#181818],#[fg=#968a6a]}\
#(~/.config/tmux/short-path.sh #{pane_current_path}) \
#{?#{!=:#(cd #{pane_current_path} && git rev-parse --abbrev-ref HEAD 2>/dev/null),},\
#{?pane_active,#[fg=#8b7535],#[fg=#585858]}│ #{?pane_active,#[fg=#181818],#[fg=#968a6a]}#(cd #{pane_current_path} && git rev-parse --abbrev-ref HEAD 2>/dev/null) ,}\
#{?pane_active,#[fg=#8b7535],#[fg=#585858]}│ \
#{?#{m:*sh,#{pane_current_command}},,#{?pane_active,#[fg=#181818],#[fg=#968a6a]}▶ }\
#{?pane_active,#[fg=#181818],#[fg=#968a6a]}#{pane_current_command} ,\
#{?pane_active,#[fg=#af87ff],#[fg=#767676]} #P \
#[fg=#585858]│ \
#{?pane_active,#[fg=#d0d0d0],#[fg=#949494]}\
#(~/.config/tmux/short-path.sh #{pane_current_path}) \
#{?#{!=:#(cd #{pane_current_path} && git rev-parse --abbrev-ref HEAD 2>/dev/null),},\
#[fg=#585858]│ \
#{?pane_active,\
#(~/.config/tmux/git-branch.sh #{pane_current_path}),\
#[fg=#767676]#(cd #{pane_current_path} && git rev-parse --abbrev-ref HEAD 2>/dev/null)} ,\
}\
#[fg=#585858]│ \
#{?#{m:*sh,#{pane_current_command}},,\
#{?pane_active,#[fg=#d7af5f],#[fg=#767676]}▶ }\
#{?pane_active,#[fg=#d7af5f],#[fg=#767676]}#{pane_current_command} }}"

# ============================================================
#  Plugins (TPM)
# ============================================================
setenv -g TMUX_PLUGIN_MANAGER_PATH '$HOME/.tmux/plugins/'

# Auto-install TPM if missing
if "test ! -d ~/.tmux/plugins/tpm" \
  "run 'git clone https://github.com/tmux-plugins/tpm ~/.tmux/plugins/tpm && \
    ~/.tmux/plugins/tpm/bin/install_plugins'"

set -g @plugin 'tmux-plugins/tmux-resurrect'
set -g @plugin 'tmux-plugins/tmux-continuum'

set -g @continuum-restore       'on'
set -g @continuum-save-interval '5'

# Initialize TPM (keep at the very end)
run '~/.tmux/plugins/tpm/tpm'
